# 530 - Fan Control Configuration

## Overview

Custom fan control configuration for MSI MPG X570 GAMING PLUS motherboard using `lm-sensors` and `fancontrol`. Replaces BIOS automatic fan curves with quieter Linux-controlled curves.

**Goal**: Quieter operation with fans running at ~30% baseline speed, ramping to 50% at ~70°C, and reaching 100% at 90°C.

## Hardware

- **Motherboard**: MSI MPG X570 GAMING PLUS (MS-7C37)
- **Sensor Chip**: Nuvoton NCT6797D Super IO Sensors
- **CPU**: AMD Ryzen 7 5800X3D 8-Core Processor
- **Kernel Module**: `nct6775`

## Installation

### Required Packages

```bash
sudo apt install lm-sensors fancontrol
```

### Module Loading

The `nct6775` kernel module provides support for the Nuvoton NCT6797D chip.

**File**: `/etc/modules-load.d/sensors.conf`

```text
nct6775
```

**Load immediately**:

```bash
sudo modprobe nct6775
```

### Sensor Detection

Run the sensor detection utility and accept all defaults:

```bash
sudo sensors-detect
```

**Detected sensors**:

- AMD Family 17h thermal sensors (k10temp driver - auto-loaded)
- Nuvoton NCT6797D Super IO Sensors (nct6775 driver)

## Fan Configuration

### Active Fans

Based on pwmconfig testing:

| PWM Output | Fan Header | Max RPM | Stop PWM | Baseline PWM | Notes                       |
|------------|------------|---------|----------|--------------|-----------------------------|
| pwm2       | CPU_FAN    | 3316    | 30       | 30           | CPU cooler fan              |
| pwm4       | SYS_FAN1   | 1205    | 70       | 65           | Case fan (needs higher PWM) |
| pwm5       | SYS_FAN2   | 1103    | 70       | 65           | Case fan (needs higher PWM) |
| pwm6       | SYS_FAN3   | 1260    | 65       | 60           | Case fan                    |
| pwm7       | PUMP_FAN   | 5487    | 75       | 75           | NVME drive cooling          |

**Note**: pwm1, pwm3 show 0 RPM - unused motherboard headers.

### Case Fan Hardware Quirk

Fan4 and Fan5 require higher PWM values than other case fans to maintain stable operation. This appears to be a hardware characteristic of these particular fans or headers. Values were adjusted to MINSTOP=70, MINPWM=65 to prevent the fan from stopping.

### Fan Curve Strategy

**Temperature Source**: CPU temperature (`hwmon1/temp1_input` - Tctl from k10temp)

**Curve Profile**:

- **Below 40°C**: Fans run at MINPWM (baseline quiet speed)
- **40°C - 90°C**: Linear interpolation from MINPWM to MAXPWM
- **Above 90°C**: Fans run at MAXPWM (full speed)

**pwm7 Exception**: Reaches full speed at 75°C instead of 90°C for more aggressive cooling of NVMe drive.

### Temperature Sensor Choice

Using **CPU temperature (Tctl)** from k10temp as the control sensor:

- Directly reflects CPU load and heat generation
- More responsive to actual system workload
- All fans use the same temperature source for consistent behavior
- CPU temp is the most relevant metric for system cooling needs

## Configuration File

**File**: `/etc/fancontrol`

```ini
# Configuration file generated by pwmconfig, changes will be lost
INTERVAL=10
DEVPATH=hwmon0=devices/pci0000:00/0000:00:01.1/0000:01:00.0/nvme/nvme0 hwmon1=devices/pci0000:00/0000:00:18.3 hwmon2=devices/platform/nct6775.2592
DEVNAME=hwmon0=nvme hwmon1=k10temp hwmon2=nct6797
FCTEMPS=hwmon2/pwm2=hwmon1/temp1_input hwmon2/pwm4=hwmon1/temp1_input hwmon2/pwm5=hwmon1/temp1_input hwmon2/pwm6=hwmon1/temp1_input hwmon2/pwm7=hwmon1/temp1_input
FCFANS=hwmon2/pwm2=hwmon2/fan2_input hwmon2/pwm4=hwmon2/fan4_input hwmon2/pwm5=hwmon2/fan5_input hwmon2/pwm6=hwmon2/fan6_input hwmon2/pwm7=hwmon2/fan7_input
MINTEMP=hwmon2/pwm2=40 hwmon2/pwm4=40 hwmon2/pwm5=40 hwmon2/pwm6=40 hwmon2/pwm7=40
MAXTEMP=hwmon2/pwm2=90 hwmon2/pwm4=90 hwmon2/pwm5=90 hwmon2/pwm6=90 hwmon2/pwm7=75
MINSTART=hwmon2/pwm2=150 hwmon2/pwm4=45 hwmon2/pwm5=45 hwmon2/pwm6=45 hwmon2/pwm7=45
MINSTOP=hwmon2/pwm2=30 hwmon2/pwm4=65 hwmon2/pwm5=75 hwmon2/pwm6=65 hwmon2/pwm7=75
MINPWM=hwmon2/pwm2=30 hwmon2/pwm4=60 hwmon2/pwm5=70 hwmon2/pwm6=60 hwmon2/pwm7=75
MAXPWM=hwmon2/pwm2=255 hwmon2/pwm4=255 hwmon2/pwm5=255 hwmon2/pwm6=255  hwmon2/pwm7=255
```

### Configuration Parameters Explained

- **INTERVAL**: Temperature check frequency in seconds (10s)
- **DEVPATH/DEVNAME**: Hardware device paths and names
- **FCTEMPS**: Maps each PWM output to its temperature sensor
- **FCFANS**: Maps each PWM output to its corresponding fan tachometer
- **MINTEMP**: Temperature threshold below which fans run at MINPWM
- **MAXTEMP**: Temperature threshold above which fans run at MAXPWM
- **MINSTART**: PWM value needed to start a stopped fan (used during initialization)
- **MINSTOP**: Minimum PWM value before fan stops (must be ≥ MINPWM)
- **MINPWM**: Baseline PWM when temperature is below MINTEMP
- **MAXPWM**: Maximum PWM when temperature exceeds MAXTEMP (255 = 100%)

**Important**: `MINSTOP` must be greater than or equal to `MINPWM`. Setting them too close together may cause fans to stop unexpectedly.

## Service Management

The `fancontrol` service is automatically enabled after package installation.

### Control Commands

```bash
# Restart service (after config changes)
sudo systemctl restart fancontrol

# Check service status
sudo systemctl status fancontrol

# View service logs
journalctl -u fancontrol -f

# Stop service (returns to BIOS control)
sudo systemctl stop fancontrol

# Disable service (prevent auto-start on boot)
sudo systemctl disable fancontrol

# Re-enable service
sudo systemctl enable fancontrol
```

### After Configuration Changes

Always restart the service after editing `/etc/fancontrol`:

```bash
sudo systemctl restart fancontrol
sudo systemctl status fancontrol
```

## Monitoring

### Real-time Sensor Monitoring

```bash
# Update every 1 second
watch -n 1 sensors

# Show only NCT6797D chip
watch -n 1 sensors nct6797-isa-0a20

# Show only k10temp (CPU)
watch -n 1 sensors k10temp-pci-00c3
```

### Expected Idle Readings

At idle (~48°C CPU temp, ~35°C system):

```text
nct6797-isa-0a20
fan2:                  2000 RPM  (CPU fan at ~40% of max)
fan4:                   500 RPM  (Case fan)
fan5:                   550 RPM  (Case fan - higher baseline due to hardware)
fan6:                   550 RPM  (Case fan)
fan7:                  2500 RPM  (High-speed fan at ~41% of max)
```

Check with:

```bash
sensors
```

## Troubleshooting

### Fans Not Responding

```bash
# Check if nct6775 module is loaded
lsmod | grep nct6775

# Load module if missing
sudo modprobe nct6775

# Check fancontrol service status
sudo systemctl status fancontrol

# Look for errors in logs
journalctl -u fancontrol --no-pager -n 50
```

### Fans Stopped or Running at Full Speed

**Common causes**:

1. **fancontrol service not running**: Start with `sudo systemctl start fancontrol`
2. **MINSTOP/MINPWM misconfiguration**: MINSTOP must be ≥ MINPWM
3. **Temperature sensor unavailable**: Verify with `cat /sys/class/hwmon/hwmon1/temp1_input`
4. **Configuration syntax error**: Check service status for error messages

### Configuration Validation Error

If you see errors like:

```text
Error in configuration file (hwmon2/pwm4):
MINSTOP must be greater than or equal to MINPWM
```

Edit `/etc/fancontrol` and ensure `MINSTOP ≥ MINPWM` for all PWM outputs.

### Fan Stops Unexpectedly

If a fan stops even though MINSTOP ≥ MINPWM:

1. Increase both MINSTOP and MINPWM by 5-10 PWM units
2. Restart fancontrol service
3. Monitor with `watch -n 1 sensors`

This was the solution for fan5, which required MINSTOP=75, MINPWM=70.

### Return to BIOS Control

To disable Linux fan control and let BIOS handle fans:

```bash
sudo systemctl stop fancontrol
sudo systemctl disable fancontrol
```

Reboot to fully restore BIOS automatic fan curves.

## Advanced Configuration

### Using Alternative Temperature Sources

**Switch to NVMe Temperature** (less recommended):

Edit `/etc/fancontrol` and change the FCTEMPS line to use `hwmon0` (NVMe) instead of `hwmon1` (CPU):

```ini
FCTEMPS=hwmon2/pwm2=hwmon0/temp1_input hwmon2/pwm4=hwmon0/temp1_input ...
```

This would make fans respond to storage temperature rather than CPU temperature.

### Per-Fan Temperature Sources

Different fans can use different temperature sensors. For example:

- CPU fan (pwm2) → CPU temp (`hwmon1/temp1_input`)
- Case fans (pwm4/5/6) → Motherboard temp (`hwmon2/temp1_input` - SYSTIN)
- Pump (pwm7) → CPU temp (`hwmon1/temp1_input`)

Edit FCTEMPS in `/etc/fancontrol` to customize per-fan temperature sources.

## Related Documentation

- [500_configurations.md](500_configurations.md) - Parent configuration page
- [300_applications.md](300_applications.md) - lm-sensors and fancontrol packages

## References

- **pwmconfig**: Interactive fan control configuration tool (`man pwmconfig`)
- **fancontrol**: Fan control daemon (`man fancontrol`)
- **sensors**: Display hardware sensor readings (`man sensors`)
- **lm-sensors documentation**: [https://hwmon.wiki.kernel.org/lm_sensors](https://hwmon.wiki.kernel.org/lm_sensors)
